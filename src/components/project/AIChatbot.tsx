import React, { useState, useRef, useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';
import { Send, Sparkles, User, Bot, Lightbulb, FileText, Image, BarChart3, Video, Copy, ThumbsUp, ThumbsDown } from 'lucide-react';
import { Button } from '../ui/Button';

interface ChatMessage {
  id: string;
  type: 'user' | 'ai';
  content: string;
  timestamp: Date;
  suggestions?: string[];
  generatedContent?: {
    type: 'text' | 'image' | 'chart' | 'video';
    title: string;
    content: string;
  };
}

interface AIChatbotProps {
  projectId: string;
  brandVoice?: string;
  audience?: string;
}

export function AIChatbot({ projectId, brandVoice, audience }: AIChatbotProps) {
  const [searchParams] = useSearchParams();
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [hasAutoGenerated, setHasAutoGenerated] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Auto-scroll to bottom
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // Focus input on mount
  useEffect(() => {
    inputRef.current?.focus();
  }, []);

  // Check for auto-generation parameter and trigger content creation
  useEffect(() => {
    const autoGenerate = searchParams.get('autoGenerate');
    
    if (autoGenerate && !hasAutoGenerated) {
      setHasAutoGenerated(true);
      
      // Add welcome message
      const welcomeMessage: ChatMessage = {
        id: 'welcome',
        type: 'ai',
        content: `Hi! I'm your AI marketing assistant. I can see you want to work on: "${autoGenerate}". Let me create that content for you right away!`,
        timestamp: new Date(),
        suggestions: [
          'Create additional content variations',
          'Generate social media posts for this',
          'Write email campaign about this topic',
          'Create supporting images'
        ]
      };
      
      setMessages([welcomeMessage]);
      
      // Automatically generate content based on the user's request
      setTimeout(() => {
        handleAutoGeneration(autoGenerate);
      }, 1000);
    } else if (!hasAutoGenerated) {
      // Default welcome message if no auto-generation
      const defaultWelcome: ChatMessage = {
        id: 'welcome',
        type: 'ai',
        content: `Hi! I'm your AI marketing assistant. I'm here to help you create amazing content for your project. I can generate blog posts, social media content, marketing copy, images, and more!

${brandVoice ? `I'll use your "${brandVoice}" brand voice` : 'Set up your brand voice in Jasper IQ for personalized content'} ${audience ? `and target your "${audience}" audience.` : 'and define your target audience for better results.'}

What would you like to create today?`,
        timestamp: new Date(),
        suggestions: [
          'Write a blog post about our product',
          'Create social media content',
          'Generate email marketing copy',
          'Design a marketing campaign'
        ]
      };
      
      setMessages([defaultWelcome]);
      setHasAutoGenerated(true);
    }
  }, [searchParams, hasAutoGenerated, brandVoice, audience]);

  // Auto-generation function
  const handleAutoGeneration = async (userRequest: string) => {
    setIsTyping(true);
    
    // Add user message
    const userMessage: ChatMessage = {
      id: `user_${Date.now()}`,
      type: 'user',
      content: userRequest,
      timestamp: new Date()
    };
    
    setMessages(prev => [...prev, userMessage]);
    
    // Generate AI response based on the request
    try {
      const aiResponse = await generateAIResponse(userRequest);
      setMessages(prev => [...prev, aiResponse]);
      
      // Add content to canvas if generated
      if (aiResponse.generatedContent && (window as any).addCanvasItem) {
        (window as any).addCanvasItem(
          aiResponse.generatedContent.type,
          aiResponse.generatedContent.content,
          aiResponse.generatedContent.title
        );
      }
    } catch (error) {
      console.error('Error generating AI response:', error);
    } finally {
      setIsTyping(false);
    }
  };

  // Simulate AI response
  const generateAIResponse = async (userMessage: string): Promise<ChatMessage> => {
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

    const messageId = `ai_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Determine response type based on user input
    const lowerMessage = userMessage.toLowerCase();
    
    if (lowerMessage.includes('blog') || lowerMessage.includes('article') || lowerMessage.includes('post') || lowerMessage.includes('summer projects')) {
      return {
        id: messageId,
        type: 'ai',
        content: `Perfect! I've created a comprehensive blog post based on your request. This content is optimized for engagement and includes practical insights your audience will love.`,
        timestamp: new Date(),
        generatedContent: {
          type: 'text',
          title: 'Creative Summer Project Ideas for an Unforgettable Season',
          content: `# Creative Summer Project Ideas for an Unforgettable Season

Summer is a time for sunny skies, longer days, and plenty of opportunities to explore your creativity. Whether you're looking for a DIY crafts session with your kids, exciting outdoor activities, or ways to give back to your community, there's something for everyone. Here's a list of inspiring and fun summer project ideas to keep individuals, families, and even groups engaged during the warmer months.

## DIY Crafts to Inspire Creativity

Unleashing your inner artist is a great way to spend summer days, and the best part? You don't need to be an expert. These craft ideas are easy, fun, and perfect for all ages.

### 1. Painted Flower Pots
Transform plain terracotta pots into vibrant pieces of art. All you'll need is acrylic paint, brushes, and a bit of imagination. These painted pots are wonderful for growing seasonal flowers or herbs.

### 2. Mason Jar Lanterns
Create magical outdoor lighting with mason jars, battery-operated fairy lights, and decorative elements like twine or lace. Perfect for evening garden parties or cozy backyard gatherings.

### 3. Rock Painting
Collect smooth rocks from your yard or local park and turn them into colorful decorations. Paint inspirational messages, animals, or abstract designs. Hide them around your neighborhood for others to find!

## Outdoor Adventures and Activities

Summer is the perfect time to step outside and embrace nature. These outdoor projects will help you make the most of the beautiful weather.

### 4. Build a Backyard Fort
Using blankets, chairs, and creativity, construct the ultimate outdoor hideaway. Add pillows, books, and snacks for the perfect summer reading nook.

### 5. Start a Container Garden
Even without a large yard, you can grow your own vegetables and herbs in containers. Tomatoes, basil, and lettuce are great options for beginners.

### 6. Create a Nature Scavenger Hunt
Design a list of items to find in your local park or backyard: specific leaves, interesting rocks, or different types of flowers. Great for kids and adults alike!

## Community and Social Projects

Summer is also an excellent time to connect with others and make a positive impact in your community.

### 7. Organize a Neighborhood Clean-Up
Rally your neighbors for a community beautification project. Provide gloves, trash bags, and refreshments for volunteers.

### 8. Host a Skill-Sharing Workshop
Do you have a talent you'd love to share? Organize a workshop to teach others photography, cooking, gardening, or any skill you're passionate about.

### 9. Create Care Packages
Assemble care packages for local homeless shelters or food banks. Include essentials like socks, toiletries, and non-perishable snacks.

## Learning and Personal Development

Use the relaxed pace of summer to pick up new skills or dive deeper into existing interests.

### 10. Start a Summer Reading Challenge
Set a goal to read a certain number of books or explore new genres. Create a reading log to track your progress and discoveries.

### 11. Learn a New Language
Use apps, online courses, or local classes to start learning a language you've always been curious about. Practice with native speakers in your community.

### 12. Document Your Summer Adventures
Start a photo journal, blog, or scrapbook to capture your summer memories. This project will give you something beautiful to look back on.

## Tips for Successful Summer Projects

- **Start small**: Choose projects that match your available time and energy
- **Involve others**: Many projects are more fun with friends or family
- **Be flexible**: Don't be afraid to modify projects based on your interests and resources
- **Document the process**: Take photos and notes to remember your creative journey
- **Celebrate completion**: Acknowledge your accomplishments, no matter how small

## Conclusion

Summer projects are about more than just staying busy—they're opportunities to learn, create, connect, and grow. Whether you choose a simple craft project or an ambitious community initiative, the key is to enjoy the process and embrace the spirit of summer exploration.

What project will you start first? Remember, the best summer project is the one that brings you joy and helps you make the most of this beautiful season.

---

*Ready to start your summer project adventure? Share your creations and inspire others in your community!*`
        },
        suggestions: [
          'Create social media posts for this blog',
          'Generate email campaign about summer projects',
          'Design infographic about summer activities',
          'Write a follow-up article about indoor projects'
        ]
      };
    }
    
    if (lowerMessage.includes('social') || lowerMessage.includes('instagram') || lowerMessage.includes('twitter') || lowerMessage.includes('facebook')) {
      return {
        id: messageId,
        type: 'ai',
        content: `Excellent! I've created engaging social media content that captures attention and drives engagement. Here are some posts tailored to your brand:`,
        timestamp: new Date(),
        generatedContent: {
          type: 'text',
          title: 'Social Media Content Pack',
          content: `🚀 **Instagram Post 1:**
"Summer project season is here! ☀️✨ 

From DIY crafts to community adventures, there's no better time to get creative and make memories. 

What's on your summer project list? Drop it in the comments! 👇

#SummerProjects #DIY #Creativity #SummerFun #MakeMemories"

---

📱 **Twitter Thread:**
1/ Summer project ideas to make this season unforgettable 🧵

2/ 🎨 DIY Crafts: Paint flower pots, create mason jar lanterns, try rock painting

3/ 🌿 Outdoor Adventures: Build backyard forts, start container gardens, organize scavenger hunts

4/ 🤝 Community Projects: Neighborhood clean-ups, skill-sharing workshops, care packages

5/ 📚 Personal Growth: Reading challenges, learn new languages, document your journey

What's your favorite summer project idea? 🌞

---

💼 **LinkedIn Post:**
"Summer isn't just about vacation—it's about growth, creativity, and community connection.

This season, consider projects that:
→ Develop new skills
→ Strengthen community bonds  
→ Create lasting memories
→ Give back to others

Whether it's starting a container garden, organizing a neighborhood workshop, or simply documenting your adventures, summer projects help us grow personally and professionally.

What project will help you make the most of this summer?"

---

📧 **Facebook Post:**
"🌻 SUMMER PROJECT INSPIRATION 🌻

Looking for ways to make this summer special? Here are some ideas that bring joy, creativity, and connection:

🎨 Get Creative: Paint, craft, and make something beautiful
🌱 Go Outside: Garden, explore, and enjoy nature
🤝 Connect: Organize community events and help others
📖 Learn: Pick up new skills and document your journey

The best summer projects aren't just about staying busy—they're about creating memories and growing as a person.

Tag someone who needs summer project inspiration! ⬇️"`
        },
        suggestions: [
          'Create images for these posts',
          'Write email campaign copy',
          'Generate video script',
          'Plan content calendar'
        ]
      };
    }
    
    if (lowerMessage.includes('email') || lowerMessage.includes('newsletter') || lowerMessage.includes('campaign')) {
      return {
        id: messageId,
        type: 'ai',
        content: `Perfect! I'll craft a compelling email campaign that drives engagement and builds relationships with your audience:`,
        timestamp: new Date(),
        generatedContent: {
          type: 'text',
          title: 'Summer Projects Email Campaign',
          content: `**Subject Line:** "Your summer adventure starts with one simple project ☀️"

**Preview Text:** "12 creative ideas to make this season unforgettable..."

---

**Email Body:**

Hi [First Name],

Summer is here, and with it comes endless possibilities for creativity, growth, and connection. 

Whether you have 30 minutes or an entire weekend, there's a perfect project waiting for you.

**🎨 For the Creative Soul:**
• Paint terracotta pots and fill them with herbs
• Create magical mason jar lanterns for evening gatherings
• Start a rock painting project to spread joy in your neighborhood

**🌿 For the Nature Lover:**
• Build the ultimate backyard reading fort
• Start a container garden (even apartment dwellers can join!)
• Organize a nature scavenger hunt for the whole family

**🤝 For the Community Builder:**
• Rally neighbors for a beautification project
• Host a skill-sharing workshop
• Create care packages for those in need

**📚 For the Lifelong Learner:**
• Set a summer reading challenge
• Learn a new language with daily practice
• Document your adventures in a creative journal

**The best part?** These projects aren't just about staying busy—they're about creating memories, building skills, and connecting with others.

**Ready to get started?**

Pick one project that speaks to you and commit to starting this week. Small steps lead to big adventures.

[DOWNLOAD OUR FREE SUMMER PROJECT PLANNER]

**P.S.** We'd love to see what you create! Share your projects with us on social media using #MySummerProject

Happy creating,
[Your Name]

---

**Follow-up Email 1 (1 week later):**
Subject: "How's your summer project going? (+ 3 quick wins)"

**Follow-up Email 2 (2 weeks later):**
Subject: "The surprising benefits of summer projects (you'll love #3)"

**Follow-up Email 3 (1 month later):**
Subject: "[First Name], your summer project success story?"`
        },
        suggestions: [
          'Create landing page copy',
          'Design email templates',
          'Write follow-up sequences',
          'Generate A/B test variations'
        ]
      };
    }
    
    if (lowerMessage.includes('image') || lowerMessage.includes('visual') || lowerMessage.includes('graphic') || lowerMessage.includes('design')) {
      return {
        id: messageId,
        type: 'ai',
        content: `Great idea! I'll help you create stunning visuals! Here's a concept for your marketing imagery:`,
        timestamp: new Date(),
        generatedContent: {
          type: 'image',
          title: 'Summer Projects Visual Concept',
          content: `**Visual Concept: "Summer Project Inspiration Board"**

**Description:**
A bright, cheerful collage showcasing various summer project ideas with a warm, inviting aesthetic.

**Layout & Composition:**
- Split-screen design with 6 project examples
- Bright summer color palette (coral, sunshine yellow, mint green, sky blue)
- Hand-lettered title: "Make This Summer Unforgettable"
- Subtle texture overlay for warmth

**Featured Projects:**
1. Painted flower pots with vibrant herbs
2. Mason jar lanterns glowing softly
3. Colorful painted rocks arranged artistically
4. Container garden with fresh vegetables
5. Cozy backyard reading fort
6. Community volunteers working together

**Color Palette:**
- Primary: Warm coral (#FF6B6B)
- Secondary: Sunshine yellow (#FFE66D)
- Accent: Mint green (#4ECDC4)
- Background: Soft cream (#FFF8E7)
- Text: Deep navy (#2C3E50)

**Typography:**
- Headlines: Playful hand-lettered style
- Body text: Clean, readable sans-serif
- Accent text: Script font for warmth

**Visual Elements:**
- Watercolor splashes and brush strokes
- Subtle geometric patterns
- Natural textures (wood, fabric, paper)
- Soft drop shadows for depth

**Dimensions:** 1200x800px (perfect for social media and web)

**Style:** Bright, optimistic, approachable, and inspiring - perfect for summer motivation`
        },
        suggestions: [
          'Generate more image concepts',
          'Create social media graphics',
          'Design infographic layout',
          'Make video thumbnail'
        ]
      };
    }

    // Default response for any other request
    return {
      id: messageId,
      type: 'ai',
      content: `I understand you'd like help with "${userMessage}". I can assist you with creating various types of marketing content including:

• **Blog posts and articles** - SEO-optimized, engaging content
• **Social media content** - Posts, captions, and hashtags  
• **Email campaigns** - Subject lines, sequences, and newsletters
• **Marketing copy** - Landing pages, ads, and sales materials
• **Visual concepts** - Image ideas and design briefs
• **Video scripts** - YouTube, TikTok, and promotional videos

What specific type of content would you like me to create for your project?`,
      timestamp: new Date(),
      suggestions: [
        'Write a blog post',
        'Create social media content',
        'Generate email campaign',
        'Design marketing visuals'
      ]
    };
  };

  // Handle sending message
  const handleSendMessage = async () => {
    if (!inputValue.trim()) return;

    const userMessage: ChatMessage = {
      id: `user_${Date.now()}`,
      type: 'user',
      content: inputValue,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputValue('');
    setIsTyping(true);

    try {
      const aiResponse = await generateAIResponse(inputValue);
      setMessages(prev => [...prev, aiResponse]);
      
      // Add content to canvas if generated
      if (aiResponse.generatedContent && (window as any).addCanvasItem) {
        (window as any).addCanvasItem(
          aiResponse.generatedContent.type,
          aiResponse.generatedContent.content,
          aiResponse.generatedContent.title
        );
      }
    } catch (error) {
      console.error('Error generating AI response:', error);
    } finally {
      setIsTyping(false);
    }
  };

  // Handle suggestion click
  const handleSuggestionClick = (suggestion: string) => {
    setInputValue(suggestion);
    inputRef.current?.focus();
  };

  // Handle key press
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  // Copy content to clipboard
  const copyToClipboard = (content: string) => {
    navigator.clipboard.writeText(content);
    // You could add a toast notification here
  };

  return (
    <div className="w-96 bg-white border-l border-gray-200 flex flex-col h-full">
      {/* Chat Header */}
      <div className="p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
            <Sparkles className="w-6 h-6 text-white" />
          </div>
          <div>
            <h3 className="font-semibold text-gray-900">AI Assistant</h3>
            <p className="text-sm text-gray-600">Your marketing co-pilot</p>
          </div>
        </div>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
        {messages.map((message) => (
          <div key={message.id} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] ${message.type === 'user' ? 'order-2' : 'order-1'}`}>
              {/* Avatar */}
              <div className={`flex items-center gap-2 mb-2 ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                  message.type === 'user' 
                    ? 'bg-gray-200 order-2' 
                    : 'bg-gradient-to-br from-indigo-500 to-purple-600 order-1'
                }`}>
                  {message.type === 'user' ? (
                    <User size={14} className="text-gray-600" />
                  ) : (
                    <Bot size={14} className="text-white" />
                  )}
                </div>
                <span className="text-xs text-gray-500">
                  {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
              </div>

              {/* Message Content */}
              <div className={`rounded-lg p-3 ${
                message.type === 'user'
                  ? 'bg-indigo-600 text-white'
                  : 'bg-gray-100 text-gray-900'
              }`}>
                <div className="whitespace-pre-wrap text-sm leading-relaxed">
                  {message.content}
                </div>

                {/* Generated Content */}
                {message.generatedContent && (
                  <div className="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        {message.generatedContent.type === 'text' && <FileText size={16} className="text-blue-600" />}
                        {message.generatedContent.type === 'image' && <Image size={16} className="text-green-600" />}
                        {message.generatedContent.type === 'chart' && <BarChart3 size={16} className="text-purple-600" />}
                        {message.generatedContent.type === 'video' && <Video size={16} className="text-orange-600" />}
                        <span className="text-sm font-medium text-gray-900">
                          {message.generatedContent.title}
                        </span>
                      </div>
                      <button
                        onClick={() => copyToClipboard(message.generatedContent!.content)}
                        className="p-1 text-gray-400 hover:text-gray-600 rounded"
                        title="Copy to clipboard"
                      >
                        <Copy size={14} />
                      </button>
                    </div>
                    <div className="text-xs text-gray-600 bg-gray-50 p-2 rounded max-h-32 overflow-y-auto">
                      {message.generatedContent.content.length > 200 
                        ? `${message.generatedContent.content.substring(0, 200)}...`
                        : message.generatedContent.content
                      }
                    </div>
                    <div className="flex items-center gap-2 mt-2">
                      <Button size="sm" variant="outline" className="text-xs">
                        Added to Canvas ✓
                      </Button>
                      <button className="p-1 text-gray-400 hover:text-green-600">
                        <ThumbsUp size={14} />
                      </button>
                      <button className="p-1 text-gray-400 hover:text-red-600">
                        <ThumbsDown size={14} />
                      </button>
                    </div>
                  </div>
                )}

                {/* Suggestions */}
                {message.suggestions && (
                  <div className="mt-3 space-y-2">
                    {message.suggestions.map((suggestion, index) => (
                      <button
                        key={index}
                        onClick={() => handleSuggestionClick(suggestion)}
                        className="block w-full text-left p-2 text-xs bg-white/10 hover:bg-white/20 rounded border border-white/20 transition-colors"
                      >
                        <Lightbulb size={12} className="inline mr-2" />
                        {suggestion}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}

        {/* Typing Indicator */}
        {isTyping && (
          <div className="flex justify-start">
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                <Bot size={14} className="text-white" />
              </div>
              <div className="bg-gray-100 rounded-lg p-3">
                <div className="flex space-x-1">
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                </div>
              </div>
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="p-4 border-t border-gray-200 bg-gray-50">
        <div className="flex gap-2">
          <input
            ref={inputRef}
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Ask me to create marketing content..."
            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
            disabled={isTyping}
          />
          <Button
            onClick={handleSendMessage}
            disabled={!inputValue.trim() || isTyping}
            size="sm"
            className="px-3"
          >
            <Send size={16} />
          </Button>
        </div>
        <p className="text-xs text-gray-500 mt-2">
          AI can make mistakes. Verify important information.
        </p>
      </div>
    </div>
  );
}